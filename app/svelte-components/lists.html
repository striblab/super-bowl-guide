<div class="main-visual">
  {{#if mainVisual}}
    <picture>
      <source
        type="image/webp"
        srcset="{{ srcset(data.basePath, mainVisual, 'webp') }}"
        sizes="100vw">
      <source
        type="image/jpeg"
        srcset="{{ srcset(data.basePath, mainVisual) }}"
        sizes="100vw">
      <img
        alt="Main image for '{{ mainVisualTitle }}'"
        src="{{ data.basePath }}/{{ mainVisual }}">
    </picture>
  {{/if}}
</div>

<div class="component component-list has-minor-navigation">
  <nav class="minor-navigation items-2 minor-nav-lists">
    {{#if data.groups && data.groups[0] }}
      <h1>{{ data.groups[0].title }}</h1>
    {{/if}}
  </nav>

  <article class="lists">
    <h1 class="heading-alternate">{{ data.title }}</h1>

    <div class="byline">
      {{#if fullByline}}
        {{{ data.byline }}}
      {{else}}
        <strong>By {{ escapeHTML(data.byline) }}</strong> • Star Tribune
      {{/if}}
    </div>

    <div class="social-buttons social-buttons-gray">
      <a href="{{ facebookURL }}" target="_blank" rel="noopener" class="facebook-button">
        <span class="sr-only">Share on Facebook</span>
      </a>
      <a href="{{ twitterURL }}" target="_blank" rel="noopener" class="twitter-button">
        <span class="sr-only">Share on Twitter</span>
      </a>
      <a href="{{ emailURL }}" target="_blank" rel="noopener" class="email-button">
        <span class="sr-only">Share via email</span>
      </a>
    </div>

    <div class="article-description">{{{ data.description }}}</div>

    <nav class="toggle-nav">
      {{#if utils && utils.hasGeolocate }}
        <ul class="cf">
          <li><a href="#/alpha" on:click="sortAlpha(event)" class="alphabetical {{ view === 'alpha' ? 'active' : '' }}">Alphabetical</a></li>
          <li>
            <a href="#/distance" on:click="sortDistance(event)" class="distance {{ view === 'distance' ? 'active' : '' }}">
              Near Me
              {{#if isGeolocating}}
                <i class="fa fa-spinner fa-spin"></i>
              {{/if}}
            </a>
          </li>
        </ul>
      {{/if}}
    </nav>

    {{#if data.items}}
      <div class="item-list">
        {{#each data.items as p @id}}
          <Item data="{{ p }}" utils="{{ utils }}" store="{{ store }}"
            display="list" view="{{ view }}" content="{{ content }}" />
        {{/each}}
      </div>
    {{else}}
      <div><em>This list should have items.</em></div>
    {{/if}}

    <div class="ad ad-placeholder">
      Ad Placeholder
    </div>
  </article>
</div>

<script>
import Item from './items.html';
import observe from '../observe.js';

export default {
  components: {
    Item
  },

  oncreate() {
    this.observe('data', n => {
      if (!n) {
        return;
      }

      if (n.mainImageLocal) {
        // When data is set, make default main visual
        this.set({ mainVisual: n.mainImageLocal });
      }

      // Observe list
      if (this.get('isBrowser')) {
        this.__itemObserver = observe({
          visibleThreshold: 0.5,
          elements: document.querySelectorAll('.item-list .component-item'),
          onObserve: _.bind(this.observeItem, this)
        });
      }
    });
  },

  ondestroy() {
    let u = this.get('utils');
    if (u) {
      u.stopGeolocate();
    }
  },

  methods: {
    observeItem: function(id) {
      let item = _.find(this.get('data').items, { id: id });

      // Update image
      if (item && item.mainImageLocal) {
        this.set({
          mainVisual: item.mainImageLocal,
          mainVisualAlt: item.imageDescription
        });
      }
    },

    sortAlpha: function(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      this.set({ view: 'alpha' });
      let d = this.get('data');
      d.items = _.sortBy(d.items, i => {
        return i.title || i.name;
      });
      this.set({ data: d });
    },

    sortDistance: function(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      this.set({ view: 'distance' });
      this.geolocate((error, position) => {
        // TODO: Handle error
        if (error) {
          console.error(error);
          return;
        }

        let d = this.get('data');
        d.items = _.sortBy(d.items, i => {
          // Set distance
          if (i.latitude && i.longitude) {
            i.distance = this.distance(
              i.latitude,
              i.longitude,
              position.lat,
              position.lng
            );
          }

          return i.distance || 999999;
        });
        this.set({ data: d });
      });
    },

    geolocate: function(done) {
      let u = this.get('utils');
      if (u && u.hasGeolocate) {
        this.set({ isGeolocating: true });

        // Check if we have a location, use that, but still update
        let store = this.get('store');
        if (
          store &&
          store.location &&
          store.location.lat &&
          _.isFunction(done)
        ) {
          done(null, store.location);
        }

        // Geolocate
        u.geolocate((error, position) => {
          this.set({ isGeolocating: false });

          if (error) {
            if (_.isFunction(done)) {
              return done(error);
            }
          } else if (position) {
            this.set({ store: { location: position } });

            if (_.isFunction(done)) {
              return done(null, position);
            }
          }
        });
      }
    },

    // http://www.geodatasource.com/developers/javascript
    distance: function(lat1, lng1, lat2, lng2, unit = 'miles') {
      let radlat1 = Math.PI * lat1 / 180;
      let radlat2 = Math.PI * lat2 / 180;
      let theta = lng1 - lng2;
      let radtheta = Math.PI * theta / 180;
      let dist =
        Math.sin(radlat1) * Math.sin(radlat2) +
        Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
      dist = Math.acos(dist);
      dist = dist * 180 / Math.PI;
      dist = dist * 60 * 1.1515;
      if (unit === 'kilometers') {
        dist = dist * 1.609344;
      }
      if (unit === 'nautical') {
        dist = dist * 0.8684;
      }
      return dist;
    }
  },

  helpers: {
    escapeHTML: function(input) {
      return input ? input.replace(/(<([^>]+)>)/gi, '') : '';
    },

    srcset: function(basePath, imagePath, extension) {
      let p = basePath + '/' + imagePath;

      return ['300', '600', '900', '1200', '2000']
        .map(w => {
          return (
            p
              .replace(/\.([a-z]+$)/i, '-' + w + 'px.$1')
              .replace(/\.([a-z]+$)/i, extension ? '.' + extension : '.$1') +
            ' ' +
            w +
            'w'
          );
        })
        .join(', ');
    }
  },

  computed: {
    fullByline: function(data) {
      return data && data.byline && ~data.byline.indexOf('•');
    },

    facebookURL: function(data, content) {
      return `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
        data.baseURL + data.filename
      )}`;
    },

    twitterURL: function(data, content) {
      return `https://twitter.com/intent/tweet?text=${encodeURIComponent(
        data.twitterShare || content.twitterShare
      )}&url=${encodeURIComponent(
        data.baseURL + data.filename
      )}&via=${encodeURIComponent(content.twitterAccount)}`;
    },

    emailURL: function(data, content) {
      return `mailto:RECIPIENT?subject=${encodeURIComponent(
        data.emailShare || content.emailShare
      )}&body=${encodeURIComponent(data.baseURL + data.filename)}`;
    }
  },

  data() {
    return {
      isBrowser: typeof window !== undefined,
      view: 'alpha'
    };
  }
};
</script>
