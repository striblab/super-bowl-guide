<div class="main-visual">
  {{#if data.mainVisual}}
    <picture>
      <source
        type="image/webp"
        srcset="{{ srcset(data.basePath, data.mainVisual, 'webp') }}"
        sizes="100vw">
      <source
        type="image/jpeg"
        srcset="{{ srcset(data.basePath, data.mainVisual) }}"
        sizes="100vw">
      <img
        alt="{{ data.mainVisualDescription }}"
        src="{{ data.basePath }}/{{ data.mainVisual }}">
    </picture>
  {{/if}}
</div>

<div class="component component-group has-minor-navigation view-{{ view }}">
  <nav class="minor-navigation adjust-header">
    <h1>{{ data.title }}</h1>

    {{#if hasLocations}}
      <ul class="cf">
        <li><a href="#/featured" on:click="eventSet(event, { view: 'featured' })"
          class="featured {{ view === 'featured' ? 'active' : '' }}">Featured</a></li>
        <li><a href="#/map" on:click="eventSet(event, { view: 'map' })"
          class="distance {{ view === 'map' ? 'active' : '' }}">Map</a></li>
      </ul>
    {{/if}}
  </nav>

  {{#if view === 'featured'}}
    <ul class="groups-items">
      {{#each allListsItems as i @airtableId}}
        <li on:mouseover="hoverItem(event, i)" data-id="{{ i.id }}" class="{{ i.inView ? 'in-view' : '' }}">
          <a href="{{ data.basePath }}/{{ i.filename }}">
            {{#if i.mainImage && i.mainImage[0] }}
              <picture>
                <source
                  type="image/webp"
                  srcset="{{ srcset(data.basePath, i.mainImageLocal, 'webp') }}"
                  sizes="100vw">
                <source
                  type="image/jpeg"
                  srcset="{{ srcset(data.basePath, i.mainImageLocal) }}"
                  sizes="100vw">
                <img
                  alt="Main image for '{{ i.title }}'"
                  src="{{ data.basePath }}/{{ i.mainImageLocal }}">
              </picture>
            {{/if}}
            <span>{{ i.title || i.name }}</span>
          </a>
        </li>
      {{/each}}
    </ul>

    <div class="ad ad-placeholder">
      Ad Placeholder
    </div>
  {{/if}}

  {{#if view === 'map'}}
    <div class="map-items-container">
      <div class="map-wrapper">
        <div class="map" ref:itemsMap></div>
      </div>

      <div class="map-items">
        {{#each allItems as i @airtableId}}
          <Item data="{{ i }}" utils="{{ utils }}" store="{{ store }}"
            display="map" view="{{ view }}" content="{{ content }}" />
        {{/each}}

        <div class="ad ad-placeholder">
          Ad Placeholder
        </div>
      </div>
    </div>
  {{/if}}
</div>

<script>
import helpers from './common/helpers.js';
import methods from './common/methods.js';
import observe from '../observe.js';
import mapStyles from '../map-styles';
import Item from './items.html';

export default {
  components: {
    Item
  },

  oncreate: function() {
    // Make all items
    this.observe('data', n => {
      if (n.items || n.lists) {
        this.set({ allItems: this.allItems(this.get('data')) });
      }
    });

    // React to view change.  Since we need to have access to the dom
    // for the map, we defer the observe
    this.observe(
      'view',
      (n, o) => {
        if (n && n !== o) {
          if (n === 'featured') {
            this.showFeatured();

            // Observe feature events
            if (!this.__featuredObserver) {
              this.__featuredObserver = observe({
                visibleThreshold: 0.75,
                elements: document.querySelectorAll('.groups-items li'),
                onObserve: _.bind(this.observeFeaturedItem, this),
                throttle: false
              });
            }
          } else if (n === 'map') {
            this.showMap();

            // Observe map events
            if (this.__mapObserver) {
              this.__mapObserver.stop();
              this.__mapObserver.addElements(
                document.querySelectorAll('.map-items .item')
              );
            } else {
              this.__mapObserver = observe({
                visibleThreshold: 0.75,
                elements: document.querySelectorAll('.map-items .item'),
                onObserve: _.bind(this.observeMapItem, this),
                throttle: false
              });
            }
          }
        }
      },
      { defer: true }
    );
  },

  methods: {
    eventSet: methods.eventSet,

    // Set view to featured
    showFeatured: function() {
      this.set({ view: 'featured' });
    },

    // Set view to map
    showMap: function() {
      this.set({ view: 'map' });

      if (this.get('isBrowser') && window.google) {
        this.drawMap();
      }
    },

    // Find item by ID
    findByID(id) {
      let data = this.get('data');
      let allItems = this.allItems(data);

      if (id && data.lists && _.find(data.lists, { id: id })) {
        return _.find(data.lists, { id: id });
      } else if (id && data.items && _.find(data.items, { id: id })) {
        return _.find(data.items, { id: id });
      } else if (id && allItems && _.find(allItems, { id: id })) {
        return _.find(allItems, { id: id });
      }
    },

    // Set all lists and items
    setAll(values, set = true) {
      let data = this.get('data');
      let allItems = this.allItems(data);

      if (data.lists) {
        data.lists = _.map(data.lists, l => _.extend(l, values));
      }
      if (data.items) {
        data.items = _.map(data.items, l => _.extend(l, values));
      }
      if (allItems) {
        allItems = _.map(allItems, l => _.extend(l, values));
      }

      if (set) {
        this.set({ data: data });
      }
    },

    // Observe featured item
    observeFeaturedItem(id) {
      let item = this.findByID(id);
      if (item) {
        this.setAll({ inView: false }, false);
        item.inView = true;
        this.set({ data: this.get('data') });
      }
    },

    // Hover items
    hoverItem(e, item) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      // Set main visual to hover item
      let data = this.get('data');
      data.mainVisual = item.mainImageLocal ? item.mainImageLocal : undefined;
      data.mainVisualDescription = item.mainImageDescription
        ? item.mainImageDescription
        : undefined;
      this.set({
        data: data
      });
    },

    // Observe a map item
    observeMapItem(id) {
      let item = this.findByID(id);
      let allItems = this.allItems(this.get('data'));

      if (item) {
        // Mark items in view
        this.setAll({ inView: false }, false);
        item.inView = true;

        // Update data
        this.set({ data: this.get('data') });

        // Inactive all markers
        _.each(allItems, i => {
          if (this.__markers[i.id] && this.__map) {
            this.__markers[i.id].setIcon({
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: '#0FF',
              fillOpacity: 0.8,
              strokeWeight: 1
            });
          }
        });

        // Update active marker
        if (this.__markers[item.id] && this.__map) {
          this.__markers[item.id].setIcon({
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#00F',
            fillOpacity: 0.8,
            strokeWeight: 1
          });

          // TODO: Handle user location as well
          let bounds = new window.google.maps.LatLngBounds();
          bounds.extend({
            lat: parseFloat(item.latitude),
            lng: parseFloat(item.longitude)
          });
          //this.__map.fitBounds(bounds);
          this.__map.setCenter(bounds.getCenter());
          this.__map.setZoom(14);
        }
      }
    },

    // Draw google map
    drawMap: function() {
      // Twin cities
      let defaultCenter = {
        lat: 44.9629232,
        lng: -93.159196
      };
      let defaultZoom = 11;

      // Only draw map if needed
      if (!this.__map) {
        this.__map = new window.google.maps.Map(this.refs.itemsMap, {
          zoom: defaultZoom,
          center: defaultCenter,
          zoomControl: true,
          mapTypeControl: false,
          scaleControl: false,
          streetViewControl: false,
          rotateControl: false,
          fullscreenControl: false,
          styles: mapStyles
        });

        // Create markers if needed
        if (!this.__markers || !this.__markers.length) {
          this.__markersBound = new window.google.maps.LatLngBounds();
          this.__markers = {};

          this.get('allItems').forEach(i => {
            if (i.latitude && i.longitude) {
              let p = {
                lat: parseFloat(i.latitude),
                lng: parseFloat(i.longitude)
              };

              let infowindow = new window.google.maps.InfoWindow({
                content: i.name || i.title
                // maxWidth: 200
              });

              let marker = new window.google.maps.Marker({
                position: p,
                title: i.name || i.title
              });
              marker.addListener('click', function() {
                infowindow.open(this.__map, marker);
              });

              this.__markersBound.extend(p);
              this.__markers[i.id] = marker;
            }
          });
        }

        // Add markers to map
        for (let i in this.__markers) {
          this.__markers[i].setMap(this.__map);
        }

        // Show all markers
        this.__map.fitBounds(this.__markersBound);
      } else {
        window.google.maps.event.trigger(this.__map, 'resize');
      }
    },

    // All items (items in lists)
    allItems: function(data) {
      let o = [];
      if (data.lists) {
        data.lists.forEach(l => {
          if (l.items && l.items.length) {
            o = o.concat(l.items);
          }
        });
      }
      if (data.items) {
        o = o.concat(data.items);
      }

      return o;
    }
  },

  computed: {
    // Top level lists and items
    allListsItems: function(data) {
      let o = [];
      if (data.lists) {
        o = o.concat(data.lists);
      }
      if (data.items) {
        o = o.concat(data.items);
      }

      return o;
    },

    // Determine if any item has location (otherwise, don't show)
    // map link.
    hasLocations: function(allListsItems) {
      return !!allListsItems.find(i => {
        return (
          (i && i.latitude && i.longitude) ||
          (i &&
            i.items &&
            !!i.items.find(t => {
              return t && t.latitude && t.longitude;
            }))
        );
      });
    }
  },

  helpers: {
    srcset: helpers.srcset
  },

  data() {
    return {
      isBrowser: typeof window !== undefined,
      view: 'featured'
    };
  }
};
</script>
